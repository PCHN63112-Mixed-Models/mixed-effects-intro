
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Simulating a Multilevel Model &#8212; Estimating Covariance Structures and Generalised Least Squares</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/test.css?v=a80109f0" />
    <link rel="stylesheet" type="text/css" href="_static/sphericity_3d_files/rglwidgetClass-1.3.18/rgl.css?v=57907efa" />
    <link rel="stylesheet" type="text/css" href="_static/sphericity_3d_files/htmltools-fill-0.5.8.1/fill.css?v=971cc1da" />
  
  <!-- So that users can add custom icons -->
  <script src="_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '3.multilevel-simulation';</script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/textures.src.js?v=9482728f"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/shadersrc.src.js?v=6ce05c17"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/buffer.src.js?v=1efca185"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/mouse.src.js?v=96f0b970"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/projection.src.js?v=98871b91"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/axes.src.js?v=3250d244"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/rglTimer.src.js?v=ac1c3151"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/pretty.src.js?v=4f2cffba"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/shaders.src.js?v=bbbdf37d"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/animation.src.js?v=74f9b9e8"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/pieces.src.js?v=280fd571"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/selection.src.js?v=5b47ed7d"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/init.src.js?v=f5bdcbbb"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/subscenes.src.js?v=42cb429d"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/controls.src.js?v=4b3dbe6f"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/draw.src.js?v=49d9cbaa"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/utils.src.js?v=56efe719"></script>
    <script src="_static/sphericity_3d_files/rglwidgetClass-1.3.18/rglClass.src.js?v=9e593197"></script>
    <script src="_static/sphericity_3d_files/rglWebGL-binding-1.3.18/rglWebGL.js?v=8cd6f6d7"></script>
    <script src="_static/sphericity_3d_files/htmlwidgets-1.6.4/htmlwidgets.js?v=175713be"></script>
    <script src="_static/sphericity_3d_files/CanvasMatrix4-1.3.18/CanvasMatrix.src.js?v=5a2d04be"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="From Multilevel to Mixed-effects" href="4.multilevel-to-mixed.html" />
    <link rel="prev" title="The Multilevel Framework" href="2.multilevel-framework.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="0.intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="Estimating Covariance Structures and Generalised Least Squares - Home"/>
    <img src="_static/logo.png" class="logo__image only-dark pst-js-only" alt="Estimating Covariance Structures and Generalised Least Squares - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="0.intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="1.intro-mixed.html">Introduction to Mixed-effects Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="2.multilevel-framework.html">The Multilevel Framework</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Simulating a Multilevel Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="4.multilevel-to-mixed.html">From Multilevel to Mixed-effects</a></li>
<li class="toctree-l1"><a class="reference internal" href="5.inference-mixed.html">Inference in Mixed-effects Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="summary.html">Summary</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/PCHN63112-Mixed-Models/mixed-effects-intro" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/PCHN63112-Mixed-Models/mixed-effects-intro/issues/new?title=Issue%20on%20page%20%2F3.multilevel-simulation.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/3.multilevel-simulation.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Simulating a Multilevel Model</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simulation-code">Simulation Code</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#level-2-population-distribution">Level 2 Population Distribution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#level-1-conditional-distributions">Level 1 Conditional Distributions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-marginal-distribution-of-the-data">The Marginal Distribution of the Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-marginal-mean">The Marginal Mean</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-marginal-variance">The Marginal Variance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-marginal-covariance-structure">The Marginal Covariance Structure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-is-the-between-subjects-variance-also-the-covariance">Why is the Between-subjects Variance also the Covariance?</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="simulating-a-multilevel-model">
<h1>Simulating a Multilevel Model<a class="headerlink" href="#simulating-a-multilevel-model" title="Link to this heading">#</a></h1>
<p>In the previous part of this lesson, we explored the multilevel framework from a purely theoretical and formal perspective. However, it can be tricky to wrap your head around all this, especially when you are not used to think in terms of multiple levels of variation. To try and help with this, we will explore <em>simulating</em> a multilevel model in <code class="docutils literal notranslate"><span class="pre">R</span></code>. This will serve two purposes. Firstly, it can be useful to see some code when trying to understand an abstract representation of a model. Secondly, there are some not-so-obvious consequences of the multilevel framework that make it particularly suited for repeated measurements. Although we could just state these consequences, the hope is that they are more concrete when actually seen as an emergent property of the multilevel framework.</p>
<section id="simulation-code">
<h2>Simulation Code<a class="headerlink" href="#simulation-code" title="Link to this heading">#</a></h2>
<p>The code for the simulations is given below. This is a direct implementation of the multilevel model visualised back in <a class="reference internal" href="2.multilevel-framework.html#multilevel-fig"><span class="std std-numref">Fig. 1</span></a>, though we are now using <span class="math notranslate nohighlight">\(t = 3\)</span> to show how the framework generalises to any number of repeated measures. You can spend time studying it and making the connections with the mathematical notation if you wish. However, the more important aspect is examining the <em>output</em>, so try not to get too side-tracked here.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set.seed</span><span class="p">(</span><span class="m">666</span><span class="p">)</span>

<span class="c1">#================================================================#</span>
<span class="c1"># Setup</span>
<span class="c1">#================================================================#</span>

<span class="c1"># simulation size</span>
<span class="n">n.subs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">10000</span><span class="w">                     </span><span class="c1"># big N</span>
<span class="n">n.t</span><span class="w">    </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">3</span><span class="w">                         </span><span class="c1"># 3 repeated measures</span>

<span class="c1"># fixed-effects</span>
<span class="n">mu</span><span class="w">    </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">5</span><span class="w">                          </span><span class="c1"># group-level grand mean</span>
<span class="n">alpha</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">-2</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">3</span><span class="p">)</span><span class="w">                  </span><span class="c1"># repeated measures effects</span>

<span class="c1"># variances</span>
<span class="n">sigma2.1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">2</span><span class="w">                       </span><span class="c1"># Level 1 (within-subject)</span>
<span class="n">sigma2.2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">3</span><span class="w">                       </span><span class="c1"># Level 2 (between-subjects)</span>

<span class="c1"># empty matrix for y (N x T)</span>
<span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">matrix</span><span class="p">(</span><span class="n">nrow</span><span class="o">=</span><span class="n">n.subs</span><span class="p">,</span><span class="w"> </span><span class="n">ncol</span><span class="o">=</span><span class="n">n.t</span><span class="p">)</span>

<span class="c1">#================================================================#</span>
<span class="c1"># Run the simulations</span>
<span class="c1">#================================================================#</span>

<span class="c1">#----------------------------------------------------------------#</span>
<span class="c1"># Level 2 </span>
<span class="c1">#----------------------------------------------------------------#</span>
<span class="c1"># mu[i] ~ N(mu,sigma2.2)</span>
<span class="c1">#----------------------------------------------------------------#</span>

<span class="n">mu.i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n.subs</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span><span class="w"> </span><span class="n">sd</span><span class="o">=</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">sigma2.2</span><span class="p">))</span>

<span class="c1">#----------------------------------------------------------------#</span>
<span class="c1"># Level 1 </span>
<span class="c1">#----------------------------------------------------------------#</span>
<span class="c1"># y[ij] ~ N(mu[i] + alpha[j], sigma2.1)</span>
<span class="c1">#----------------------------------------------------------------#</span>

<span class="kr">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">n.subs</span><span class="p">){</span>
<span class="w">  </span><span class="kr">for</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">n.t</span><span class="p">){</span>
<span class="w">    </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="n">mu.i</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">alpha</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="n">sd</span><span class="o">=</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">sigma2.1</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>In terms of running the code above, the main outputs are the subject means <code class="docutils literal notranslate"><span class="pre">mu.i</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">head</span><span class="p">(</span><span class="n">mu.i</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1] 6.304773 8.488965 4.384889 8.512890 1.160261 6.313581
</pre></div>
</div>
</div>
</div>
<p>and repeated measurement data itself <code class="docutils literal notranslate"><span class="pre">y</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">head</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>          [,1]     [,2]      [,3]
[1,]  4.888774 6.123403 10.577235
[2,]  6.363783 8.602728 11.434999
[3,]  3.351801 8.032131  8.484494
[4,]  7.631690 7.439201 12.534746
[5,] -2.930792 2.173460  4.901289
[6,]  4.878890 8.034805  9.735553
</pre></div>
</div>
</div>
</div>
<p>where each <em>row</em> is a subject and each <em>column</em> is one of the repeated measurement conditions. For simplicity, we will continue to refer to this condition as <code class="docutils literal notranslate"><span class="pre">time</span></code>, but it could of course be anything. Of importance is that we only have <em>one</em> measurement per-subject and per-repeat, so there are no replications here. We can see this in the Level 1 code <code class="docutils literal notranslate"><span class="pre">y[i,j]</span> <span class="pre">&lt;-</span> <span class="pre">rnorm(n=1,</span> <span class="pre">...)</span></code>. This is partly a <em>practical</em> decision to not complicate the indexing, but it does have some ramifications for visualising the model, as we will see below.</p>
</section>
<section id="level-2-population-distribution">
<h2>Level 2 Population Distribution<a class="headerlink" href="#level-2-population-distribution" title="Link to this heading">#</a></h2>
<p>To begin with, let us have a look at the simulated distribution of subject means. This is the Level 2 distribution, illustrated back in <a class="reference internal" href="2.multilevel-framework.html#multilevel-fig"><span class="std std-numref">Fig. 1</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">hist</span><span class="p">(</span><span class="n">mu.i</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="o">=</span><span class="s">&#39;Level 2&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7a2694199e203d8787921d87ca633f07795694c8908f46976412686af3b0e404.png" src="_images/7a2694199e203d8787921d87ca633f07795694c8908f46976412686af3b0e404.png" />
</div>
</div>
<p>This represents our <em>population</em> of subjects. Each values on the <span class="math notranslate nohighlight">\(x\)</span>-axis represents an average value of our outcome variable for each subject. If we take one value from this distribution, we are sampling a <em>single</em> subject as a whole. The <em>width</em> of this distribution therefore represents variation <em>between</em> the subjects. It tells us how much we expect the subjects to differ from each other on average. In the simulations, we set <span class="math notranslate nohighlight">\(\sigma^{2}_{2} = 3\)</span> and indeed we find that</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">var</span><span class="p">(</span><span class="n">mu.i</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1] 2.998582
</pre></div>
</div>
</div>
</div>
<p>which is basically 3. Importantly, the elements of this distribution are taken as <em>independent</em> because each subject is assumed not to influence the response given by any other subject. This is implicit in the simulations because the vector of subject means are created as <em>independent</em> random draws from a normal distribution. In reality, this is an <em>assumption</em>, though usually a fairly reasonable one.</p>
</section>
<section id="level-1-conditional-distributions">
<h2>Level 1 Conditional Distributions<a class="headerlink" href="#level-1-conditional-distributions" title="Link to this heading">#</a></h2>
<p>Next, let us focus on the Level 1 simulations. Remember that, for this example, we only simulated <em>one value</em> per-subject and per-repeated measurement. Because of this, we have no way of <em>seeing</em> the Level 1 distributions from <a class="reference internal" href="2.multilevel-framework.html#multilevel-fig"><span class="std std-numref">Fig. 1</span></a>. Remember, these distributions are <em>subject-specific</em>. Every subject at every level of <code class="docutils literal notranslate"><span class="pre">time</span></code> has a distribution with a <em>unique</em> mean value. Formally, these are known as <em>conditional</em> distributions because they depend upon a specific subject. We would write</p>
<div class="math notranslate nohighlight">
\[
y_{ij} | \mu_{i} \sim \mathcal{N}(\mu_{i} + \alpha_{j}, \sigma^{2}_{1}),
\]</div>
<p>which expresses the idea that this is the distribution of <span class="math notranslate nohighlight">\(y_{ij}\)</span>, but <em>only</em> for subject <span class="math notranslate nohighlight">\(i\)</span> with a mean of <span class="math notranslate nohighlight">\(\mu_{i}\)</span>. Unfortunately, for these simulations, all we have is a <em>single</em> value from each one of these distributions. So we could <em>try</em> and plot them, but histograms drawn using a single datapoint do not tend to be particularly useful.</p>
<p>So, what we can do instead is run some additional simulations on specific subjects to generate enough values for visualisation. In the code below, we choose some random subject indices and then, for each of these subject, simulate 5,000 values from their distribution for each time-point. The results of doing this are then shown in the plots below. The three example subjects are given in the columns, with the distributions for time-point shown in rows. These are now examples of the conditional Level 1 distributions from <a class="reference internal" href="2.multilevel-framework.html#multilevel-fig"><span class="std std-numref">Fig. 1</span></a>.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">subs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="m">722</span><span class="p">,</span><span class="m">8927</span><span class="p">)</span><span class="w"> </span><span class="c1"># random subject numbers</span>
<span class="n">n</span><span class="w">    </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span><span class="w">  </span><span class="c1"># number of subjects</span>

<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>

<span class="c1"># plot each distribution</span>
<span class="kr">for</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">){</span>
<span class="w">  </span><span class="kr">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">n</span><span class="p">){</span>

<span class="w">    </span><span class="c1"># subject index</span>
<span class="w">    </span><span class="n">sub.idx</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="w">    </span><span class="c1"># Level 1 distribution (n=5000 now rather than n=1)</span>
<span class="w">    </span><span class="n">sub.dist</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="m">5000</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="o">=</span><span class="n">mu.i</span><span class="p">[</span><span class="n">sub.idx</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">alpha</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="n">sd</span><span class="o">=</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">sigma2.1</span><span class="p">))</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1"># plot the distribution</span>
<span class="w">    </span><span class="nf">hist</span><span class="p">(</span><span class="n">sub.dist</span><span class="p">,</span><span class="w"> </span>
<span class="w">         </span><span class="n">main</span><span class="o">=</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&#39;Sub &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">sub.idx</span><span class="p">,</span><span class="w"> </span><span class="s">&#39; (mu.i=&#39;</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">mu.i</span><span class="p">[</span><span class="n">sub.idx</span><span class="p">]),</span><span class="w"> </span><span class="s">&#39;)\nmean=&#39;</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="nf">mean</span><span class="p">(</span><span class="n">sub.dist</span><span class="p">)),</span><span class="w"> </span><span class="s">&#39; var=&#39;</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="nf">var</span><span class="p">(</span><span class="n">sub.dist</span><span class="p">))</span><span class="w"> </span><span class="p">),</span>
<span class="w">         </span><span class="n">xlab</span><span class="o">=</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&#39;Time &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">),</span><span class="w"> </span><span class="n">breaks</span><span class="o">=</span><span class="m">20</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/782cddb580bbfc31a4a02ab19825e129ab4eff8a312377f20d1575ecfcea496f.png" src="_images/782cddb580bbfc31a4a02ab19825e129ab4eff8a312377f20d1575ecfcea496f.png" />
</div>
</div>
<p>Notice that each one of these distributions has a <em>different mean</em> (indicated by <code class="docutils literal notranslate"><span class="pre">mean=</span></code> in the histogram titles). Even if they are from the <em>same subject</em> or from the <em>same time-point</em>. This is the essence of <em>conditional</em> distributions, because the mean depends upon <em>both</em> the time-point and the subject in question. For any one of the subjects and time-points, the distribution is given by</p>
<div class="math notranslate nohighlight">
\[
y_{ij} | \mu_{i} \sim \mathcal{N}(\mu_{i} + \alpha_{j}, \sigma^{2}_{1}),
\]</div>
<p>so the <em>variance</em> is always the same, but the <em>mean</em> is a combination of something specific to that subject <span class="math notranslate nohighlight">\(\left(\mu_{i}\right)\)</span> and something <em>universal</em> across measurements from the same time-point <span class="math notranslate nohighlight">\(\left(\alpha_{j}\right)\)</span>. In the simulations, we set <span class="math notranslate nohighlight">\(\sigma^{2}_{1} = 2\)</span> and that is indeed what we see above (indicated by <code class="docutils literal notranslate"><span class="pre">var=</span></code> in the histogram titles). So this is the meaning of the <em>within-subject</em> variance, capturing the variability in measurements from <em>within a single subject</em>.</p>
<p>In terms of the means, notice that each distribution for <code class="docutils literal notranslate"><span class="pre">Time</span> <span class="pre">1</span></code> has a mean that is always 2 below the mean of the subject. So, Subject 5 has <code class="docutils literal notranslate"><span class="pre">mu.i=1</span></code> and their average response in Time 1 is <span class="math notranslate nohighlight">\(1 - 2 = -1\)</span>. Similarly, Subject 722 has <code class="docutils literal notranslate"><span class="pre">mu.i=5</span></code> and their average response in Time 1 is <span class="math notranslate nohighlight">\(5 - 2 = 3\)</span>. This is not a surprise, because in the simulations we set <code class="docutils literal notranslate"><span class="pre">alpha[1]</span> <span class="pre">&lt;-</span> <span class="pre">-2</span></code>. So, no matter the subject, the average effect of <code class="docutils literal notranslate"><span class="pre">Time</span> <span class="pre">1</span></code> is always the same. What changes is the individual subjectâ€™s mean. This dictates the <em>scaling</em> of the measurements for that subject. Some people will just have lower values in general, whereas some people will just have higher values in general. We imagine that, on average, <code class="docutils literal notranslate"><span class="pre">time</span></code> affects every person in the same way, they just all start in a different place.</p>
</section>
<section id="the-marginal-distribution-of-the-data">
<h2>The Marginal Distribution of the Data<a class="headerlink" href="#the-marginal-distribution-of-the-data" title="Link to this heading">#</a></h2>
<p>Finally, let us have a look at the actual data that has been simulated <em>across</em> all the subjects. Here, we are not focussing on any single subject. Instead we have <em>collapsed</em> over all subjects. Formally, this is referred to as the <em>marginal</em> distribution, because we are looking at values averaged across all the subjects<a class="footnote-reference brackets" href="#marginal-foot" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>. In general, the multilevel model works by decomposing the marginal distribution into a conditional distribution (Level 1) and a population distribution (Level 2). As such, the marginal distribution of the data is a combination of <em>both</em> Level 1 and Level 2. We can examine the results of the simulations to see how this has happened.</p>
<p>To begin with, we can plot the marginal distributions of each time-point from the simulations. Remember, these show the values of <em>all</em> subjects within each of the time-points. This is effectively the data for each <em>cell</em> of the design.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">))</span>
<span class="kr">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">3</span><span class="p">){</span>
<span class="w">  </span><span class="nf">hist</span><span class="p">(</span><span class="n">y</span><span class="p">[,</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">main</span><span class="o">=</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&#39;Time &#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;\nmean=&#39;</span><span class="p">,</span><span class="nf">round</span><span class="p">(</span><span class="nf">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[,</span><span class="n">i</span><span class="p">])),</span><span class="s">&#39; var=&#39;</span><span class="p">,</span><span class="nf">round</span><span class="p">(</span><span class="nf">var</span><span class="p">(</span><span class="n">y</span><span class="p">[,</span><span class="n">i</span><span class="p">]))))</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/615eef42ad231cd948d7fa6db26989eb4bb9545ebaa6328eaba5301da92aaa9e.png" src="_images/615eef42ad231cd948d7fa6db26989eb4bb9545ebaa6328eaba5301da92aaa9e.png" />
</div>
</div>
<p>To understand what these distributions are telling us about the multilevel model, we will focus on <code class="docutils literal notranslate"><span class="pre">Time</span> <span class="pre">1</span></code>, which is shown in isolation below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">hist</span><span class="p">(</span><span class="n">y</span><span class="p">[,</span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">main</span><span class="o">=</span><span class="s">&#39;Time 1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/aea8e851e809a5cb0d62a7392d0ac4d82fe395b148782d2d8118d3c8b3304aec.png" src="_images/aea8e851e809a5cb0d62a7392d0ac4d82fe395b148782d2d8118d3c8b3304aec.png" />
</div>
</div>
<section id="the-marginal-mean">
<h3>The Marginal Mean<a class="headerlink" href="#the-marginal-mean" title="Link to this heading">#</a></h3>
<p>We will start by understanding the <em>mean</em> of this distribution. This is given by</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">mean</span><span class="p">(</span><span class="n">y</span><span class="p">[,</span><span class="m">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1] 3.051084
</pre></div>
</div>
</div>
</div>
<p>Where does this value come from? Well, the <em>conditional</em> mean for <code class="docutils literal notranslate"><span class="pre">Time</span> <span class="pre">1</span></code> is given by</p>
<div class="math notranslate nohighlight">
\[
E(y_{i1}|\mu_{i}) = \mu_{i} + \alpha_{1},
\]</div>
<p>so this will jump around from subject-to-subject because the value of <span class="math notranslate nohighlight">\(\mu_{i}\)</span> will keep changing. However, if we collapse across subjects, we get</p>
<div class="math notranslate nohighlight">
\[
E(y_{i1}) = E(\mu_{i}) + \alpha_{1} = \mu + \alpha_{1}.
\]</div>
<p>Why? Because on average we expect the subject means to be equal to <span class="math notranslate nohighlight">\(\mu\)</span>. Why? Because our model says</p>
<div class="math notranslate nohighlight">
\[
\mu_{i} \sim \mathcal{N}\left(\mu,\sigma^{2}_{2}\right).
\]</div>
<p>So <span class="math notranslate nohighlight">\(E(\mu_{i}) = \mu\)</span>, which is the mean of the Level 2 distribution. Each subject mean is a draw from this distribution and so, on average, these should be equal to <span class="math notranslate nohighlight">\(\mu\)</span>. If we average-over all the subjects, we expect the average value of <span class="math notranslate nohighlight">\(\mu_{i}\)</span> to be <span class="math notranslate nohighlight">\(\mu\)</span>. Because of this, the average value for data from time-point 1 should be <span class="math notranslate nohighlight">\(\mu + \alpha_{1}\)</span>. This is the grand mean of all the subjects plus the fixed-effect of <code class="docutils literal notranslate"><span class="pre">Time</span> <span class="pre">1</span></code>.</p>
<p>In the simulations, we set <span class="math notranslate nohighlight">\(\mu = 5\)</span> and <span class="math notranslate nohighlight">\(\alpha_{1} = -2\)</span>. So, on average, a subject from this population will have a mean of 5, which will reduce by 2 during <code class="docutils literal notranslate"><span class="pre">Time</span> <span class="pre">1</span></code>. So, our distribution for <code class="docutils literal notranslate"><span class="pre">Time</span> <span class="pre">1</span></code> therefore a mean of <span class="math notranslate nohighlight">\(5 + (-2) = 3\)</span>, which is exactly what we see. This is also true of the other time-points. We set <span class="math notranslate nohighlight">\(\alpha_{2} = 1\)</span> and so our expectation across subjects is that the distribution of <code class="docutils literal notranslate"><span class="pre">Time</span> <span class="pre">2</span></code> will have a mean of <span class="math notranslate nohighlight">\(5 + 1 = 6\)</span>, which is what we see. Similarly, we set <span class="math notranslate nohighlight">\(\alpha_{3} = 3\)</span> and so our expectation across subjects is that the distribution of <code class="docutils literal notranslate"><span class="pre">Time</span> <span class="pre">3</span></code> will have a mean of <span class="math notranslate nohighlight">\(5 + 3 = 8\)</span>, which is again what we see. Importantly, these values are all products of <em>both levels</em> of the data-generating process. This demonstrates how the data are formed from Level 1 <em>and</em> Level 2 combined.</p>
</section>
<section id="the-marginal-variance">
<h3>The Marginal Variance<a class="headerlink" href="#the-marginal-variance" title="Link to this heading">#</a></h3>
<p>What about the <em>variance</em> of the marginal distribution? Again, we can calculate this from the simulations</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">var</span><span class="p">(</span><span class="n">y</span><span class="p">[,</span><span class="m">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1] 5.007147
</pre></div>
</div>
</div>
</div>
<p>Where does this value come from? Well, the <em>conditional</em> variance for <code class="docutils literal notranslate"><span class="pre">Time</span> <span class="pre">1</span></code> is given by</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{alignat*}{2}
    \text{Var}(y_{i1}|\mu_{i}) &amp;= \text{Var}(\mu_{i} + \alpha_{1} + \eta_{i1}) \\
                               &amp;= \text{Var}(\eta_{i1}) \\
                               &amp;= \sigma^{2}_{1} 
\end{alignat*}
\end{split}\]</div>
<p>because our model says <span class="math notranslate nohighlight">\(\eta_{i1} \sim \mathcal{N}\left(0,\sigma^{2}_{1}\right)\)</span>. Why do both <span class="math notranslate nohighlight">\(\mu_{i}\)</span> and <span class="math notranslate nohighlight">\(\alpha_{1}\)</span> disappear? Well, <span class="math notranslate nohighlight">\(\alpha_{1}\)</span> is a <em>population constant</em> and so its value never changes. As such, it is <em>not</em> a random variable and therefore has <em>0 variance</em>. In terms of <span class="math notranslate nohighlight">\(\mu_{i}\)</span>, that <em>is</em> a random variable. However, when we calculate the <em>conditional</em> distribution, we are doing that based on <em>one</em> specific subject. This means we <em>fix</em> <span class="math notranslate nohighlight">\(\mu_{i}\)</span> to a specific value and it no longer acts like a random variable. As such, <em>conditionally</em> <span class="math notranslate nohighlight">\(\mu_{i}\)</span> does not vary and thus also has <em>0 variance</em>. We saw this already because the conditional distributions for the example subjects above were based on fixing the value of <code class="docutils literal notranslate"><span class="pre">mu.i</span></code> to one specific value. When we did that, their variance was exactly <span class="math notranslate nohighlight">\(\sigma^{2}_{1}\)</span>.</p>
<p>Now, what happens when we collapse across subjects? Well, at that point we are not longer fixing the value of <span class="math notranslate nohighlight">\(\mu_{i}\)</span>. Thus, it still behaves like a <em>random variable</em> and thus contributes its variance to the data. This means that <span class="math notranslate nohighlight">\(\alpha_{1}\)</span> will still drop-out, but <em><span class="math notranslate nohighlight">\(\mu_{i}\)</span> will not</em>. This results in</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{alignat*}{2}
    \text{Var}(y_{i1}) &amp;= \text{Var}(\mu_{i} + \alpha_{1} + \eta_{i1}) \\
                       &amp;= \text{Var}(\mu_{i}) + \text{Var}(\eta_{i1}) \\
                       &amp;= \text{Var}(\xi_{i}) + \text{Var}(\eta_{i1}) \\
                       &amp;= \sigma^{2}_{1} + \sigma^{2}_{2} 
\end{alignat*}
\end{split}\]</div>
<p>So, the variance of the marginal distribution is <span class="math notranslate nohighlight">\(\sigma^{2}_{1} + \sigma^{2}_{2}\)</span>. This means that <em>both</em> levels of the data are contributing to the variance we see in our data. This is <em>exactly</em> what we see in the simulations. There we set <span class="math notranslate nohighlight">\(\sigma^{2}_{1} = 2\)</span> and <span class="math notranslate nohighlight">\(\sigma^{2}_{2} = 3\)</span>. So we expect that variance of the data will be <span class="math notranslate nohighlight">\(\sigma^{2}_{1} + \sigma^{2}_{2} = 2 + 3 = 5\)</span>. Which is <em>exactly</em> what we saw above.</p>
<p>More generally, if we think of these as the <em>within-subject</em> variance <span class="math notranslate nohighlight">\(\left(\sigma^{2}_{w}\right)\)</span> and the <em>between-subjects</em> variance <span class="math notranslate nohighlight">\(\left(\sigma^{2}_{b}\right)\)</span> then the variance of our data is a <em>combination</em> of both these sources. So, <span class="math notranslate nohighlight">\(\text{Var}\left(y_{ij}\right) = \sigma^{2}_{w} + \sigma^{2}_{b}\)</span>. The multilevel model simply decomposes <em>where</em> these variance come from. The <em>within-subject</em> variation comes from the conditional distribution of each subject (Level 1), whereas the <em>between-subjects</em> comes from the population distribution (Level 2). So, both the <em>mean</em> and the <em>variance</em> of our measured data are <em>combinations</em> of both levels. This framework therefore allows us to understand complex data by modelling its structure layer-by-layer. Each layer can be very simple, but combined they can capture quite complex patterns in the data.</p>
<div class="tip admonition">
<p class="admonition-title">Intuition About Sources of Variance</p>
<p>Although the information given above is dressed up very formally, the insight itself is actually very simple and intuitive. If you take a friend and measure them several times, do you expect the response to be <em>identical</em> each time? Probably not, because there are random factors at play that will shift the response each time. The measurements may be very <em>similar</em> but they will not be <em>identical</em>. Now imagine that you do the same with another friend. Again, the measurements will differ, no matter how subtly, every time they are taken. Now collapse those two sets of measurements together. The data you have now contains <em>two</em> sources of variation. The first is the variation you have already noticed in terms of repeated measurements within each of your friends. However, you have also introduced a <em>second</em> source by collapsing the data together. The fact that these measurements were taken from <em>two</em> different people will also be a clear source of variation. Perhaps one friend consistently measures <em>lower</em> than the other? So now you have variation caused by inconsistencies <em>within</em> each of your friends, but also inconsistencies <em>between</em> each of your friends as well.</p>
</div>
</section>
<section id="the-marginal-covariance-structure">
<h3>The Marginal Covariance Structure<a class="headerlink" href="#the-marginal-covariance-structure" title="Link to this heading">#</a></h3>
<p>Now, for the party trick.</p>
<p>During this section of the unit, we have spent a lot of time discussing the covariance structure of the data. Yet this has been suspiciously absent so far in this lesson. Now we can start to join-the-dots. To see how, let us calculate and visualise the variance-covariance matrix of our simulated repeated measurements.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">Matrix</span><span class="p">)</span>
<span class="n">Sigma</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">var</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">Sigma</span><span class="p">)</span>
<span class="nf">image</span><span class="p">(</span><span class="nf">as</span><span class="p">(</span><span class="n">Sigma</span><span class="p">,</span><span class="s">&#39;Matrix&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>         [,1]     [,2]     [,3]
[1,] 5.007147 3.024842 3.016017
[2,] 3.024842 5.001325 2.958006
[3,] 3.016017 2.958006 5.002542
</pre></div>
</div>
<img alt="_images/ff49ca10e467ac7d9ea8951faf589ada79dc749d5be9b4016dce21f9655705a4.png" src="_images/ff49ca10e467ac7d9ea8951faf589ada79dc749d5be9b4016dce21f9655705a4.png" />
</div>
</div>
<p>Does this look familiar?</p>
<p>For starters, the simulated values of <code class="docutils literal notranslate"><span class="pre">time</span></code> are <em>correlated</em>. Now, this is not necessarily surprising, given that these are repeated measurements. <em>However</em>, consider for a moment the fact that <em>we did not simulate any correlation</em>. There is no multivariate normal distribution with a given covariance structure <em>anywhere</em> in the simulation code. In fact, no value for any correlation was specified. So where did this come from?</p>
<p>This covariance is, in fact, a <em>natural consequence</em> of how a multilevel model is constructed. We do not need to specify correlation because it happens <em>automatically</em> as part of the connection between the levels of the model. This feels a bit like a magic trick, but is one of the big advantages of a multilevel model. We do not need to explicitly model dependence like we did with GLS. Instead, if we specify the structure of the model in terms of its layers, the covariance structure is taken into account <em>automatically</em>. Instead of thinking in terms of covariance structures, we can instead think about data structures. So long as we get the structure right, the correlation will be there as an emergent property of the model. In fact, we do not even need to think about correlation. This is particularly advantageous when we have complex data with more than two levels of variation. So long as we model the levels correctly, a complex covariance structure can simply fall-out of the model automatically.</p>
<p>The other familiar element here is that this structure is <em>compound symmetric</em>. So, the covariance structure that emerges from this model is one of <em>identical</em> variances and <em>identical</em> covariances. The variances themselves, along the diagonal, are all <span class="math notranslate nohighlight">\(\sigma^{2}_{1} + \sigma^{2}_{2} = 5\)</span>. This fits with what we saw in the histograms of the marginal distributions of the data above. The variance of our data is a <em>combination</em> of the variances at the two-levels of the model. In other words, the sum of the <em>within-subject</em> and the <em>between-subjects</em> variance.</p>
<p>What about the <em>covariances</em> on the off-diagonal? Well, these all have a value of approximately 3. What did we set to 3 in the simulations? This is the value of <span class="math notranslate nohighlight">\(\sigma^{2}_{2}\)</span>. In other words, the <em>between-subjects</em> variance. So, given what the simulations have shown us, we can conclude that</p>
<div class="math notranslate nohighlight">
\[
\text{Cov}\left(y_{ij},y_{ij^{\prime}}\right) = \sigma^{2}_{2} = \sigma^{2}_{b}.
\]</div>
<p>This can also be derived formally, but the simulations make it much clearer that this is <em>exactly</em> what happens.</p>
</section>
<section id="why-is-the-between-subjects-variance-also-the-covariance">
<h3>Why is the Between-subjects Variance also the Covariance?<a class="headerlink" href="#why-is-the-between-subjects-variance-also-the-covariance" title="Link to this heading">#</a></h3>
<p>The result that the covariance between the repeated measures <em>is</em> the between-subjects variance may not be immediately intuitive. In order to see this, remember that the element that <em>connects</em> the measurements from within a single subject is the subject mean <span class="math notranslate nohighlight">\(\mu_{i}\)</span>. This is the element that shifts the responses for a single subject up or down in one go. So, the only reason why the measures are correlated is because of <span class="math notranslate nohighlight">\(\mu_{i}\)</span>. The more the values of <span class="math notranslate nohighlight">\(\mu_{i}\)</span> shift, the larger the correlation. This implies that it is the <em>variance</em> of <span class="math notranslate nohighlight">\(\mu_{i}\)</span> that controls the degree of correlation. So what is the variance of <span class="math notranslate nohighlight">\(\mu_{i}\)</span>? Well, according to our model <span class="math notranslate nohighlight">\(\mu_{i} \sim \mathcal{N}(\mu,\sigma^{2}_{2})\)</span>. So therefore, the correlation is directly controlled by <span class="math notranslate nohighlight">\(\sigma^{2}_{2}\)</span>. In other words, <em>the between-subjects variance</em>.</p>
<p>This can be confusing to wrap your head around, so the plot below shows an example of both <em>large</em> between-subject variance and <em>small</em> between-subject variance and how this affects correlation. The plots on the <em>left</em> show each subject along the <span class="math notranslate nohighlight">\(x\)</span>-axis, with their mean response (black circles) and two repeated measurements (white circles) illustrated. The plots on the <em>right</em> then show the correlation pattern between these two repeats across subjects.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/42ff834faf3e0559f9705febe433d5a813e517ba2971d1b05cd50e6a79363fb7.png" src="_images/42ff834faf3e0559f9705febe433d5a813e517ba2971d1b05cd50e6a79363fb7.png" />
</div>
</div>
<p>So we can see that <em>high between-subjects variance</em> is directly associated with <em>strong correlation</em> and <em>low between-subjects variance</em> is directly associated with <em>weak correlation</em>. Indeed, the <em>correlation</em> between two measurements from the same subject is given by</p>
<div class="math notranslate nohighlight">
\[
\text{Corr}\left(y_{ij},y_{ij^{\prime}}\right) = \frac{\sigma^{2}_{2}}{\sigma^{2}_{1} + \sigma^{2}_{2}} = \frac{\sigma^{2}_{b}}{\sigma^{2}_{b} + \sigma^{2}_{w}}.
\]</div>
<p>This is also known as the <em>intraclass correlation coefficient</em> (ICC) and depends directly upon <span class="math notranslate nohighlight">\(\sigma^{2}_{b}\)</span>.</p>
<p>Another way to look at this is ordering the subjects by their mean value. This results in the plots below.</p>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<img alt="_images/d48e96bfe6c99049485813ab5bb0491ce20644d7650acbb2631fa125144b09d8.png" src="_images/d48e96bfe6c99049485813ab5bb0491ce20644d7650acbb2631fa125144b09d8.png" />
</div>
</div>
<p>Now, consider our ability to predict one repeated measurement based on the other. Looking at the <em>left</em> plot, if the first measurement is <em>high</em> then we can predict with reasonable certainty that the second measurement will also be <em>high</em>. The same is true of <em>low</em> values and <em>middle</em> values. So when the subjects are <em>spread-out</em>, we can much more easily predict one measurement from the other. This is the <em>definition</em> of high correlation. Looking at the <em>right</em> plot, if the first measurement is <em>high</em> then our ability to accurately predict the second is diminished. Yes, some of the <em>high</em> values are associated with other <em>high</em> values, but some are associated with <em>low</em> values. Although there is <em>some</em> pattern here, because the subjects are so squashed together, this is much less certain than in the the <em>left</em> plot. This is the <em>definition</em> of low correlation.</p>
<p>So, we can see here that the <em>spread</em> of the subjects directly impacts our ability to predict one value from the other and therefore is <em>directly</em> related to the correlation between the repeated measurements. Hence it is the variability in the subject means that dictates the degree of correlation between our measurements. The simulations have told us this <em>explicitly</em> and so it <em>must</em> be true. It is just up to us to understand <em>why</em> this is the case, even if it feels unintuitive.</p>
<aside class="topic">
<p class="topic-title">What do you now know?</p>
<p>In this section, we have explored â€¦ . After reading this section, you should have a good sense of :</p>
<ul class="simple">
<li><p>â€¦</p></li>
<li><p>â€¦</p></li>
<li><p>â€¦</p></li>
</ul>
</aside>
<hr class="footnotes docutils" />
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="marginal-foot" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>The origin of this term is the same as <em>marginal means</em> in ANOVA tables. We are effectively <em>collapsing</em> over a specific dimension which, traditionally, would be performed by writing totals in the <em>margins</em> of a table.</p>
</aside>
</aside>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "r"
        },
        kernelOptions: {
            name: "ir",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ir'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="2.multilevel-framework.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">The Multilevel Framework</p>
      </div>
    </a>
    <a class="right-next"
       href="4.multilevel-to-mixed.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">From Multilevel to Mixed-effects</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simulation-code">Simulation Code</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#level-2-population-distribution">Level 2 Population Distribution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#level-1-conditional-distributions">Level 1 Conditional Distributions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-marginal-distribution-of-the-data">The Marginal Distribution of the Data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-marginal-mean">The Marginal Mean</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-marginal-variance">The Marginal Variance</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-marginal-covariance-structure">The Marginal Covariance Structure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#why-is-the-between-subjects-variance-also-the-covariance">Why is the Between-subjects Variance also the Covariance?</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dr Martyn McFarquhar
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      Â© Copyright 2026.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>